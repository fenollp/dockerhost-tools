name: Build
on:
  push: {}
jobs:
  metaci:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - run: ./generate_ci.sh
    - run: git status -sb && [[ 1 -eq $(git status -sb | wc -l) ]]

  apple-neural-hash:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apple-neural-hash
    steps:
    - uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    - uses: actions/checkout@v2
    - run: |
        echo GOT=$(mktemp) >>$GITHUB_ENV
        EXPECTED=$(mktemp)
        base64 -d <<<'MzcxNzQwODdjYzJiMDBkZjQ3ZTY4Y2NmCg==' >$EXPECTED
        echo EXPECTED=$EXPECTED >>$GITHUB_ENV
    - run: |
        DOCKER_BUILDKIT=1 docker build -o=. --build-arg IMAGE_URL='https://placekitten.com/200/140' - <Dockerfile && cat out 1>$GOT
      name: " with some JPEG"
    - run: |
        echo expected:
        cat -A $EXPECTED
        echo got:
        cat -A $GOT
        diff --width=150 -y $EXPECTED $GOT
    - run: git status -sb && [[ 1 -eq $(git status -sb | wc -l) ]]

    - run: |
        echo GOT=$(mktemp) >>$GITHUB_ENV
        EXPECTED=$(mktemp)
        base64 -d <<<'NTlhMzRlYWJlMzE5MTBhYmZiMDZmMzA4Cg==' >$EXPECTED
        echo EXPECTED=$EXPECTED >>$GITHUB_ENV
    - run: |
        DOCKER_BUILDKIT=1 docker build -o=. --build-arg IMAGE_URL=https://user-images.githubusercontent.com/1328/129860794-e7eb0132-d929-4c9d-b92e-4e4faba9e849.png - <Dockerfile && cat out 1>$GOT
      name: " pre-image example..."
    - run: |
        echo expected:
        cat -A $EXPECTED
        echo got:
        cat -A $GOT
        diff --width=150 -y $EXPECTED $GOT
    - run: git status -sb && [[ 1 -eq $(git status -sb | wc -l) ]]

    - run: |
        echo GOT=$(mktemp) >>$GITHUB_ENV
        EXPECTED=$(mktemp)
        base64 -d <<<'NTlhMzRlYWJlMzE5MTBhYmZiMDZmMzA4Cg==' >$EXPECTED
        echo EXPECTED=$EXPECTED >>$GITHUB_ENV
    - run: |
        DOCKER_BUILDKIT=1 docker build -o=. --build-arg IMAGE_URL=https://user-images.githubusercontent.com/1328/129860810-f414259a-3253-43e3-9e8e-a0ef78372233.png - <Dockerfile && cat out 1>$GOT
      name: " ...from https://github.com/AsuharietYgvar/AppleNeuralHash2ONNX/issues/1#issue-973388387"
    - run: |
        echo expected:
        cat -A $EXPECTED
        echo got:
        cat -A $GOT
        diff --width=150 -y $EXPECTED $GOT
    - run: git status -sb && [[ 1 -eq $(git status -sb | wc -l) ]]


  deepspeech:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: deepspeech
    steps:
    - uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    - uses: actions/checkout@v2
    - run: |
        echo GOT=$(mktemp) >>$GITHUB_ENV
        EXPECTED=$(mktemp)
        base64 -d <<<'ewogICAgImNvbmZpZGVuY2UiOiAtODUuNzAyODY1NjAwNTg1OTQsCiAgICAid29yZHMiOiBbCiAgICAgICAgewogICAgICAgICAgICAiZHVyYXRpb24iOiAwLjEsCiAgICAgICAgICAgICJzdGFydF90aW1lIjogMC4yOCwKICAgICAgICAgICAgIndvcmQiOiAiaSIKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICAgImR1cmF0aW9uIjogMC4xNiwKICAgICAgICAgICAgInN0YXJ0X3RpbWUiOiAwLjQyLAogICAgICAgICAgICAid29yZCI6ICJrbm93IgogICAgICAgIH0sCiAgICAgICAgewogICAgICAgICAgICAiZHVyYXRpb24iOiAwLjEyLAogICAgICAgICAgICAic3RhcnRfdGltZSI6IDAuNjIsCiAgICAgICAgICAgICJ3b3JkIjogInRoYXQiCiAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICAgICJkdXJhdGlvbiI6IDAuMTIsCiAgICAgICAgICAgICJzdGFydF90aW1lIjogMC44LAogICAgICAgICAgICAid29yZCI6ICJ5b3UiCiAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICAgICJkdXJhdGlvbiI6IDAuMTgsCiAgICAgICAgICAgICJzdGFydF90aW1lIjogMC45OCwKICAgICAgICAgICAgIndvcmQiOiAiYW5kIgogICAgICAgIH0sCiAgICAgICAgewogICAgICAgICAgICAiZHVyYXRpb24iOiAwLjI4LAogICAgICAgICAgICAic3RhcnRfdGltZSI6IDEuMiwKICAgICAgICAgICAgIndvcmQiOiAiZnJhbmsiCiAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICAgICJkdXJhdGlvbiI6IDAuMTgsCiAgICAgICAgICAgICJzdGFydF90aW1lIjogMS41NiwKICAgICAgICAgICAgIndvcmQiOiAid2VyZSIKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICAgImR1cmF0aW9uIjogMC4yOCwKICAgICAgICAgICAgInN0YXJ0X3RpbWUiOiAxLjc4LAogICAgICAgICAgICAid29yZCI6ICJwbGFubmluZyIKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICAgImR1cmF0aW9uIjogMC4xMiwKICAgICAgICAgICAgInN0YXJ0X3RpbWUiOiAyLjEsCiAgICAgICAgICAgICJ3b3JkIjogInRvIgogICAgICAgIH0sCiAgICAgICAgewogICAgICAgICAgICAiZHVyYXRpb24iOiAwLjU2LAogICAgICAgICAgICAic3RhcnRfdGltZSI6IDIuMywKICAgICAgICAgICAgIndvcmQiOiAiZGlzY29ubmVjdCIKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICAgImR1cmF0aW9uIjogMC42LAogICAgICAgICAgICAic3RhcnRfdGltZSI6IDIuOTQsCiAgICAgICAgICAgICJ3b3JkIjogIm1lIgogICAgICAgIH0sCiAgICAgICAgewogICAgICAgICAgICAiZHVyYXRpb24iOiAwLjEsCiAgICAgICAgICAgICJzdGFydF90aW1lIjogMy42NCwKICAgICAgICAgICAgIndvcmQiOiAiYW5kIgogICAgICAgIH0sCiAgICAgICAgewogICAgICAgICAgICAiZHVyYXRpb24iOiAwLjEsCiAgICAgICAgICAgICJzdGFydF90aW1lIjogMy44MiwKICAgICAgICAgICAgIndvcmQiOiAiaSdtIgogICAgICAgIH0sCiAgICAgICAgewogICAgICAgICAgICAiZHVyYXRpb24iOiAwLjMyLAogICAgICAgICAgICAic3RhcnRfdGltZSI6IDQsCiAgICAgICAgICAgICJ3b3JkIjogImFmcmFpZCIKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICAgImR1cmF0aW9uIjogMC4yLAogICAgICAgICAgICAic3RhcnRfdGltZSI6IDQuMzgsCiAgICAgICAgICAgICJ3b3JkIjogInRoYXQiCiAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICAgICJkdXJhdGlvbiI6IDAuMywKICAgICAgICAgICAgInN0YXJ0X3RpbWUiOiA0LjYyLAogICAgICAgICAgICAid29yZCI6ICJzb21ldGhpbmciCiAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICAgICJkdXJhdGlvbiI6IDAuMDgsCiAgICAgICAgICAgICJzdGFydF90aW1lIjogNS4wNCwKICAgICAgICAgICAgIndvcmQiOiAiaSIKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICAgImR1cmF0aW9uIjogMC4yNCwKICAgICAgICAgICAgInN0YXJ0X3RpbWUiOiA1LjE4LAogICAgICAgICAgICAid29yZCI6ICJjYW5ub3QiCiAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICAgICJkdXJhdGlvbiI6IDAuMjYsCiAgICAgICAgICAgICJzdGFydF90aW1lIjogNS40OCwKICAgICAgICAgICAgIndvcmQiOiAiYWxsb3ciCiAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICAgICJkdXJhdGlvbiI6IDAuMDgsCiAgICAgICAgICAgICJzdGFydF90aW1lIjogNS44LAogICAgICAgICAgICAid29yZCI6ICJ0byIKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICAgImR1cmF0aW9uIjogMC4xNiwKICAgICAgICAgICAgInN0YXJ0X3RpbWUiOiA1Ljk0LAogICAgICAgICAgICAid29yZCI6ICJoYXZlIgogICAgICAgIH0KICAgIF0KfQo=' >$EXPECTED
        echo EXPECTED=$EXPECTED >>$GITHUB_ENV
    - run: |
        DOCKER_BUILDKIT=1 docker build -o=. --build-arg AUDIO_URL=https://www.wavsource.com/snds_2020-10-01_3728627494378403/movies/2001/disconnect_me.wav - <Dockerfile && cat out | jq -S --tab '.transcripts[0]'; rm out 1>$GOT
    - run: |
        echo expected:
        cat -A $EXPECTED
        echo got:
        cat -A $GOT
        diff --width=150 -y $EXPECTED $GOT
    - run: git status -sb && [[ 1 -eq $(git status -sb | wc -l) ]]


  reinforcement-learning-gym-stable-baselines3:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: reinforcement-learning-gym-stable-baselines3
    steps:
    - uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    - uses: actions/checkout@v2
    - run: |
        echo GOT=$(mktemp) >>$GITHUB_ENV
        EXPECTED=$(mktemp)
        base64 -d <<<'RG9ja2VyZmlsZQpwcG8KdGVuc29yYm9hcmQK' >$EXPECTED
        echo EXPECTED=$EXPECTED >>$GITHUB_ENV
    - run: |
        DOCKER_BUILDKIT=1 docker build -o=. --build-arg ARGs='-n 100' --progress=plain - <Dockerfile && ls -1 . #&& python enjoy.py --algo ppo --env CartPole-v1 --folder . --exp-id 0 && tensorboard --logdir tensorboard 1>$GOT
    - run: |
        echo expected:
        cat -A $EXPECTED
        echo got:
        cat -A $GOT
        diff --width=150 -y $EXPECTED $GOT
    - run: git status -sb && [[ 1 -eq $(git status -sb | wc -l) ]]


  youtube-dl:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: youtube-dl
    steps:
    - uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    - uses: actions/checkout@v2
    - run: |
        echo GOT=$(mktemp) >>$GITHUB_ENV
        EXPECTED=$(mktemp)
        base64 -d <<<'RG9ja2VyZmlsZQonRXJsYW5nIC0gVGhlIE1vdmllIChGaXhlZCBBdWRpbyktQlhtT2xDeTBvQk0ubXA0JwonUmljayBBc3RsZXkgLSBOZXZlciBHb25uYSBHaXZlIFlvdSBVcCAoT2ZmaWNpYWwgTXVzaWMgVmlkZW8pLWRRdzR3OVdnWGNRLm1wNCcK' >$EXPECTED
        echo EXPECTED=$EXPECTED >>$GITHUB_ENV
    - run: |
        DOCKER_BUILDKIT=1 docker build -o=. --build-arg PIP_PACKAGE=git+https://github.com/ytdl-org/youtube-dl@refs/pull/30184/merge --build-arg ARGs='--format mp4 -- https://www.youtube.com/watch?v=BXmOlCy0oBM https://www.youtube.com/watch?v=dQw4w9WgXcQ' - <Dockerfile && ls -1 . 1>$GOT
    - run: |
        echo expected:
        cat -A $EXPECTED
        echo got:
        cat -A $GOT
        diff --width=150 -y $EXPECTED $GOT
    - run: git status -sb && [[ 1 -eq $(git status -sb | wc -l) ]]


  yt-dlp:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: yt-dlp
    steps:
    - uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    - uses: actions/checkout@v2
    - run: |
        echo GOT=$(mktemp) >>$GITHUB_ENV
        EXPECTED=$(mktemp)
        base64 -d <<<'RG9ja2VyZmlsZQpFcmxhbmcgLSBUaGUgTW92aWUgKEZpeGVkIEF1ZGlvKS1CWG1PbEN5MG9CTS5tcDQKUmljayBBc3RsZXkgLSBOZXZlciBHb25uYSBHaXZlIFlvdSBVcCAoT2ZmaWNpYWwgTXVzaWMgVmlkZW8pLWRRdzR3OVdnWGNRLm1wNAo=' >$EXPECTED
        echo EXPECTED=$EXPECTED >>$GITHUB_ENV
    - run: |
        DOCKER_BUILDKIT=1 docker build -o=. --build-arg ARGs='--format mp4 -- https://www.youtube.com/watch?v=BXmOlCy0oBM https://www.youtube.com/watch?v=dQw4w9WgXcQ' - <Dockerfile && ls -1 . && rm 'Erlang - The Movie (Fixed Audio)-BXmOlCy0oBM.mp4' 'Rick Astley - Never Gonna Give You Up (Official Music Video)-dQw4w9WgXcQ.mp4' 1>$GOT
    - run: |
        echo expected:
        cat -A $EXPECTED
        echo got:
        cat -A $GOT
        diff --width=150 -y $EXPECTED $GOT
    - run: git status -sb && [[ 1 -eq $(git status -sb | wc -l) ]]

