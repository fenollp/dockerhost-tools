name: Build
on:
  push: {}
jobs:
  metaci:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - run: ./generate_ci.sh
    - run: git status -sb && [[ 1 -eq $(git status -sb | wc -l) ]]

  apple-neural-hash:
    needs: metaci
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apple-neural-hash
    steps:
    - uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    - uses: actions/checkout@v2
    - run: |
        echo GOT=$(mktemp) >>$GITHUB_ENV
        EXPECTED=$(mktemp)
        base64 -d <<<'MzcxNzQwODdjYzJiMDBkZjQ3ZTY4Y2NmCg==' >$EXPECTED
        echo EXPECTED=$EXPECTED >>$GITHUB_ENV
    - run: |
        DOCKER_BUILDKIT=1 docker build -o=. --build-arg IMAGE_URL='https://placekitten.com/200/140' - <Dockerfile && cat out 1>$GOT
      name: " with some JPEG"
    - run: |
        echo expected:
        cat -A $EXPECTED
        echo got:
        cat -A $GOT
        echo diff:
        diff --width=150 -y $EXPECTED $GOT
    - run: git status -sb && [[ 1 -eq $(git status -sb | wc -l) ]]

    - run: |
        echo GOT=$(mktemp) >>$GITHUB_ENV
        EXPECTED=$(mktemp)
        base64 -d <<<'NTlhMzRlYWJlMzE5MTBhYmZiMDZmMzA4Cg==' >$EXPECTED
        echo EXPECTED=$EXPECTED >>$GITHUB_ENV
    - run: |
        DOCKER_BUILDKIT=1 docker build -o=. --build-arg IMAGE_URL=https://user-images.githubusercontent.com/1328/129860794-e7eb0132-d929-4c9d-b92e-4e4faba9e849.png - <Dockerfile && cat out 1>$GOT
      name: " pre-image example..."
    - run: |
        echo expected:
        cat -A $EXPECTED
        echo got:
        cat -A $GOT
        echo diff:
        diff --width=150 -y $EXPECTED $GOT
    - run: git status -sb && [[ 1 -eq $(git status -sb | wc -l) ]]

    - run: |
        echo GOT=$(mktemp) >>$GITHUB_ENV
        EXPECTED=$(mktemp)
        base64 -d <<<'NTlhMzRlYWJlMzE5MTBhYmZiMDZmMzA4Cg==' >$EXPECTED
        echo EXPECTED=$EXPECTED >>$GITHUB_ENV
    - run: |
        DOCKER_BUILDKIT=1 docker build -o=. --build-arg IMAGE_URL=https://user-images.githubusercontent.com/1328/129860810-f414259a-3253-43e3-9e8e-a0ef78372233.png - <Dockerfile && cat out 1>$GOT
      name: " ...from https://github.com/AsuharietYgvar/AppleNeuralHash2ONNX/issues/1#issue-973388387"
    - run: |
        echo expected:
        cat -A $EXPECTED
        echo got:
        cat -A $GOT
        echo diff:
        diff --width=150 -y $EXPECTED $GOT
    - run: git status -sb && [[ 1 -eq $(git status -sb | wc -l) ]]


  deepspeech:
    needs: metaci
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: deepspeech
    steps:
    - uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    - uses: actions/checkout@v2
    - run: |
        echo GOT=$(mktemp) >>$GITHUB_ENV
        EXPECTED=$(mktemp)
        base64 -d <<<'ewoJImNvbmZpZGVuY2UiOiAtODUuNzAyODY1NjAwNTg1OTQsCgkid29yZHMiOiBbCgkJewoJCQkiZHVyYXRpb24iOiAwLjEsCgkJCSJzdGFydF90aW1lIjogMC4yOCwKCQkJIndvcmQiOiAiaSIKCQl9LAoJCXsKCQkJImR1cmF0aW9uIjogMC4xNiwKCQkJInN0YXJ0X3RpbWUiOiAwLjQyLAoJCQkid29yZCI6ICJrbm93IgoJCX0sCgkJewoJCQkiZHVyYXRpb24iOiAwLjEyLAoJCQkic3RhcnRfdGltZSI6IDAuNjIsCgkJCSJ3b3JkIjogInRoYXQiCgkJfSwKCQl7CgkJCSJkdXJhdGlvbiI6IDAuMTIsCgkJCSJzdGFydF90aW1lIjogMC44LAoJCQkid29yZCI6ICJ5b3UiCgkJfSwKCQl7CgkJCSJkdXJhdGlvbiI6IDAuMTgsCgkJCSJzdGFydF90aW1lIjogMC45OCwKCQkJIndvcmQiOiAiYW5kIgoJCX0sCgkJewoJCQkiZHVyYXRpb24iOiAwLjI4LAoJCQkic3RhcnRfdGltZSI6IDEuMiwKCQkJIndvcmQiOiAiZnJhbmsiCgkJfSwKCQl7CgkJCSJkdXJhdGlvbiI6IDAuMTgsCgkJCSJzdGFydF90aW1lIjogMS41NiwKCQkJIndvcmQiOiAid2VyZSIKCQl9LAoJCXsKCQkJImR1cmF0aW9uIjogMC4yOCwKCQkJInN0YXJ0X3RpbWUiOiAxLjc4LAoJCQkid29yZCI6ICJwbGFubmluZyIKCQl9LAoJCXsKCQkJImR1cmF0aW9uIjogMC4xMiwKCQkJInN0YXJ0X3RpbWUiOiAyLjEsCgkJCSJ3b3JkIjogInRvIgoJCX0sCgkJewoJCQkiZHVyYXRpb24iOiAwLjU2LAoJCQkic3RhcnRfdGltZSI6IDIuMywKCQkJIndvcmQiOiAiZGlzY29ubmVjdCIKCQl9LAoJCXsKCQkJImR1cmF0aW9uIjogMC42LAoJCQkic3RhcnRfdGltZSI6IDIuOTQsCgkJCSJ3b3JkIjogIm1lIgoJCX0sCgkJewoJCQkiZHVyYXRpb24iOiAwLjEsCgkJCSJzdGFydF90aW1lIjogMy42NCwKCQkJIndvcmQiOiAiYW5kIgoJCX0sCgkJewoJCQkiZHVyYXRpb24iOiAwLjEsCgkJCSJzdGFydF90aW1lIjogMy44MiwKCQkJIndvcmQiOiAiaSdtIgoJCX0sCgkJewoJCQkiZHVyYXRpb24iOiAwLjMyLAoJCQkic3RhcnRfdGltZSI6IDQsCgkJCSJ3b3JkIjogImFmcmFpZCIKCQl9LAoJCXsKCQkJImR1cmF0aW9uIjogMC4yLAoJCQkic3RhcnRfdGltZSI6IDQuMzgsCgkJCSJ3b3JkIjogInRoYXQiCgkJfSwKCQl7CgkJCSJkdXJhdGlvbiI6IDAuMywKCQkJInN0YXJ0X3RpbWUiOiA0LjYyLAoJCQkid29yZCI6ICJzb21ldGhpbmciCgkJfSwKCQl7CgkJCSJkdXJhdGlvbiI6IDAuMDgsCgkJCSJzdGFydF90aW1lIjogNS4wNCwKCQkJIndvcmQiOiAiaSIKCQl9LAoJCXsKCQkJImR1cmF0aW9uIjogMC4yNCwKCQkJInN0YXJ0X3RpbWUiOiA1LjE4LAoJCQkid29yZCI6ICJjYW5ub3QiCgkJfSwKCQl7CgkJCSJkdXJhdGlvbiI6IDAuMjYsCgkJCSJzdGFydF90aW1lIjogNS40OCwKCQkJIndvcmQiOiAiYWxsb3ciCgkJfSwKCQl7CgkJCSJkdXJhdGlvbiI6IDAuMDgsCgkJCSJzdGFydF90aW1lIjogNS44LAoJCQkid29yZCI6ICJ0byIKCQl9LAoJCXsKCQkJImR1cmF0aW9uIjogMC4xNiwKCQkJInN0YXJ0X3RpbWUiOiA1Ljk0LAoJCQkid29yZCI6ICJoYXZlIgoJCX0KCV0KfQo=' >$EXPECTED
        echo EXPECTED=$EXPECTED >>$GITHUB_ENV
    - run: |
        DOCKER_BUILDKIT=1 docker build -o=. --build-arg AUDIO_URL=https://www.wavsource.com/snds_2020-10-01_3728627494378403/movies/2001/disconnect_me.wav - <Dockerfile && ( cat out | jq -S --tab '.transcripts[0]' && rm out ) 1>$GOT
    - run: |
        echo expected:
        cat -A $EXPECTED
        echo got:
        cat -A $GOT
        echo diff:
        diff --width=150 -y $EXPECTED $GOT
    - run: git status -sb && [[ 1 -eq $(git status -sb | wc -l) ]]


  reinforcement-learning-gym-stable-baselines3:
    needs: metaci
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: reinforcement-learning-gym-stable-baselines3
    steps:
    - uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    - uses: actions/checkout@v2
    - run: |
        echo GOT=$(mktemp) >>$GITHUB_ENV
        EXPECTED=$(mktemp)
        base64 -d <<<'RG9ja2VyZmlsZQpwcG8KdGVuc29yYm9hcmQK' >$EXPECTED
        echo EXPECTED=$EXPECTED >>$GITHUB_ENV
    - run: |
        DOCKER_BUILDKIT=1 docker build -o=. --build-arg ARGs='-n 100' --progress=plain - <Dockerfile && ( ls -1 . && rm ppo tensorboard ) 1>$GOT
    - run: |
        echo expected:
        cat -A $EXPECTED
        echo got:
        cat -A $GOT
        echo diff:
        diff --width=150 -y $EXPECTED $GOT
    - run: git status -sb && [[ 1 -eq $(git status -sb | wc -l) ]]


  youtube-dl:
    needs: metaci
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: youtube-dl
    steps:
    - uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    - uses: actions/checkout@v2
    - run: |
        echo GOT=$(mktemp) >>$GITHUB_ENV
        EXPECTED=$(mktemp)
        base64 -d <<<'RG9ja2VyZmlsZQpFcmxhbmcgLSBUaGUgTW92aWUgKEZpeGVkIEF1ZGlvKS1CWG1PbEN5MG9CTS5tcDQKUmljayBBc3RsZXkgLSBOZXZlciBHb25uYSBHaXZlIFlvdSBVcCAoT2ZmaWNpYWwgTXVzaWMgVmlkZW8pLWRRdzR3OVdnWGNRLm1wNAo=' >$EXPECTED
        echo EXPECTED=$EXPECTED >>$GITHUB_ENV
    - run: |
        DOCKER_BUILDKIT=1 docker build -o=. --build-arg PIP_PACKAGE=git+https://github.com/ytdl-org/youtube-dl@refs/pull/30184/merge --build-arg ARGs='--format mp4 -- https://www.youtube.com/watch?v=BXmOlCy0oBM https://www.youtube.com/watch?v=dQw4w9WgXcQ' - <Dockerfile && ( ls -1 . && rm 'Erlang - The Movie (Fixed Audio)-BXmOlCy0oBM.mp4' 'Rick Astley - Never Gonna Give You Up (Official Music Video)-dQw4w9WgXcQ.mp4' ) 1>$GOT
    - run: |
        echo expected:
        cat -A $EXPECTED
        echo got:
        cat -A $GOT
        echo diff:
        diff --width=150 -y $EXPECTED $GOT
    - run: git status -sb && [[ 1 -eq $(git status -sb | wc -l) ]]


  yt-dlp:
    needs: metaci
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: yt-dlp
    steps:
    - uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    - uses: actions/checkout@v2
    - run: |
        echo GOT=$(mktemp) >>$GITHUB_ENV
        EXPECTED=$(mktemp)
        base64 -d <<<'RG9ja2VyZmlsZQpFcmxhbmcgLSBUaGUgTW92aWUgKEZpeGVkIEF1ZGlvKS1CWG1PbEN5MG9CTS5tcDQKUmljayBBc3RsZXkgLSBOZXZlciBHb25uYSBHaXZlIFlvdSBVcCAoT2ZmaWNpYWwgTXVzaWMgVmlkZW8pLWRRdzR3OVdnWGNRLm1wNAo=' >$EXPECTED
        echo EXPECTED=$EXPECTED >>$GITHUB_ENV
    - run: |
        DOCKER_BUILDKIT=1 docker build -o=. --build-arg ARGs='--format mp4 -- https://www.youtube.com/watch?v=BXmOlCy0oBM https://www.youtube.com/watch?v=dQw4w9WgXcQ' - <Dockerfile && ( ls -1 . && rm 'Erlang - The Movie (Fixed Audio)-BXmOlCy0oBM.mp4' 'Rick Astley - Never Gonna Give You Up (Official Music Video)-dQw4w9WgXcQ.mp4' ) 1>$GOT
    - run: |
        echo expected:
        cat -A $EXPECTED
        echo got:
        cat -A $GOT
        echo diff:
        diff --width=150 -y $EXPECTED $GOT
    - run: git status -sb && [[ 1 -eq $(git status -sb | wc -l) ]]

